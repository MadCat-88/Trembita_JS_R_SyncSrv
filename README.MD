## Сервіс керування даними про осіб на базі REST з Node.js та Express.js

Це RESTful API, побудоване з використанням Node.js та Express.js для управління даними про осіб.

### Опис

Цей сервер Node.js Express дозволяє керувати списком осіб. Він надає ендпоінти для виконання операцій CRUD над записами про осіб, збереженими у базі даних. Сервер використовує Sequelize як ORM для взаємодії з базою даних і має функції, такі як перевірка введених даних, логування та обробка помилок.

### Ручне встановлення

1. Впевніться, що встановлені всі необхідні залежності, включаючи Node.js та npm.

2. Клонуйте репозиторій:

```bash
git clone https://github.com/roman-lakhnov/rest-sync-service-node-express-js.git
```

3. Перейдіть у директорію проекту:

```bash
cd rest-sync-service-node-express-js
```

4. Встановіть залежності:

```bash
npm install
```

5. Створіть файл .env у кореневій директорії проекту і заповніть необхідні змінні середовища. Зразок данних наведено в файлі .env.example.

### Встановлення за допомогою скрипта deploy.sh

Ми додали скрипт `deploy.sh` для автоматизації процесу встановлення. Скрипт виконує наступні кроки:
1. Встановлює системні залежності.
2. Клонує репозиторій.
3. Встановлює залежності Node js.
4. Налаштовує конфігурацію бази даних.
5. Створює структуру бази даних.
6. Створює `systemd` сервіс для запуску застосунку.

#### Використання скрипта deploy.sh

1. Відредагуйте скрипт `deploy.sh`, замінивши значення змінних `DB_USER`, `DB_PASSWORD`, `DB_NAME` на ваші бажані дані.
2. Зробіть файл виконуваним:

   ```bash
   chmod +x deploy.sh
   ```

3. Запустіть скрипт:

   ```bash
   ./deploy.sh
   ```

### Використання

#### Ручний запуск сервера

Щоб запустити сервер у режимі продакшену, виконайте команду:

```bash
npm start
```

Для запуску сервера у режимі розробки з nodemon (автоматично перезапускається при зміні файлів) виконайте:

```bash
npm run dev
```

### Swagger Документація

Документація вашого API, автоматично створена з використанням Swagger, надає інтерактивний спосіб ознайомитися з усіма доступними ендпоінтами, параметрами запитів та структурою даних.

Для перегляду Swagger-документації, після запуску сервісу перейдіть за адресою:

http://адреса_вашого_api/api-docs

#### Використання Swagger

Swagger надає зручний інтерфейс для тестування та використання вашого API. Ви можете:

- Оглядати список доступних ендпоінтів.
- Детально ознайомитися з параметрами кожного ендпоінту.
- Виконувати запити безпосередньо з інтерфейсу Swagger.

В разі внесення змін до ендпоінтів сервера, для актуалізаціі Swagger-документації виконайте:

```bash
npm run swagger
```

### Документація

1. **Опис роутів**
   - `/person`
     - `POST`: Створення нового запису про особу.
     - `GET`: Отримання списку осіб за параметрами запиту.
     - `PUT`: Оновлення осіб за атрибутом.
     - `DELETE`: Видалення осіб за атрибутом.
   - `/status`
     - `GET`: Отримання статусу сервісу (Heartbeat).

2. **Валідація запитів**
   Для створення запису про особу використовується middleware для валідації даних. Перевіряються наступні поля: ім'я, прізвище, по батькові, дата народження, коди RNOKPP та UNZR, номер паспорту та стать за наступними критеріями:
   - name: Перевіряє, щоб довжина поля була від 1 до 50 символів.
    - surname: Перевіряє, щоб довжина поля була від 1 до 50 символів.
    - patronym: Якщо присутнє, перевіряє, щоб довжина поля не була більше 50 символів.
    - dateOfBirth: Перевіряє, щоб поле містило дату у форматі 'YYYY-MM-DD'.
    - rnokpp: Перевіряє, щоб довжина поля дорівнювала 10 символів.
    - unzr: Перевіряє, щоб довжина поля дорівнювала 14 символів.
    - passportNumber: Перевіряє, щоб довжина поля дорівнювала 9 символів.
    - gender: Перевіряє, щоб значення поля було або "male", або "female".
    
    Якщо будь-яка перевірка не пройде, видається відповідне повідомлення про помилку.

3. **Санітаризація запитів**

    Middleware для валідації даних також виконує санітаризацію запитів. 
    
    Санітайзер видаляє пробіли з обох кінців рядка, а також замінює <, >, &, ', " та / відповідними об'єктами HTML. Це сприяє для запобігання атакам XSS, гарантуючи, що введені користувачем дані розглядаються як звичайний текст, а не як виконуваний HTML або JavaScript.
    
    ORM Sequelize використовує параметризовані запити для взаємодії з базою даних, що відокремлює логіку SQL від даних. 

    Це забезпечує надійний захист від атак SQL-ін’єкцій.

4. **Логування**
   - Здійснюється логування HTTP запитів та відповідей, а також помилок за допомогою Winston logger. Логи зберігаються у відповідних файлах згідно налаштувань середовища.

5. **Обробка помилок**
   - Помилки під час виконання запитів обробляються та логуються. Клієнт отримує відповідний статус та повідомлення про помилку.

6. **Контролери та Сервіси**
   - Всі операції з базою даних винесені у сервіси, а логіка керування ними зосереджена у контролерах.

7. **Місця бізнес-логіки**
   - Бізнес-логіка зосереджена у сервісах та контролерах, які здійснюють операції з даними.

### Ендпоінти детально

#### Створення Особи

Для створення нового запису про особу виконайте POST запит на адресу /person, передаючи необхідні дані в тілі запиту.

- **URL:** `/person`
- **Метод:** `POST`
- **Тіло запиту:**

  ```json
  {
    "name": "Тарас",
    "surname": "Шевченко",
    "patronym": "Григорович",
    "dateOfBirth": "1991-03-09",
    "rnokpp": "1234567890",
    "unzr": "12345678-12345",
    "passportNumber": "123456789",
    "gender": "male"
  }
  ```

#### Отримання Осіб за параметрами запиту

Для отримання списку осіб виконайте GET запит на адресу /person, можливо також вказати різні параметри фільтрації.

- **URL:** `/person`
- **Метод:** `GET`
- **Параметри запиту:** 
 (Будь-яке поєднання атрибутів особи, на приклад 
?name=Adam&dateOfBirth=1991-03-09)


#### Оновлення Осіб за атрибутом

Для оновлення інформації про осіб виконайте PUT запит на адресу /person, передаючи назву атрибуту та значення, а також нові дані в тілі запиту.

- **URL:** `/person`
- **Метод:** `PUT`
- **Тіло запиту:**

  ```json
  { 
    "attribute": "unzr",
    "value": "12345678-12345",
    "name": "Степан",
  }
  ```

#### Видалення Особи за унікальним атрибутом

Для видалення записів виконайте DELETE запит на адресу /person, передаючи назву атрибуту та значення, для осіб котрих потрібно видалити.

- **URL:** `/person`
- **Метод:** `DELETE`
- **Тіло запиту:**

  ```json
  { 
    "attribute": "unzr",
    "value": "12345678-12345"
  }
  ```

#### Отримання статусу сервісу (Heartbeat)

Сервер підтримує Heartbeat link для перевірки статусу сервісу. Це можна зробити шляхом виконання GET-запиту на маршрут `/status`.

- **URL:** `/status`
- **Метод:** `GET`

### Приклади використання

Припускаючи, що сервер працює локально на порту 3000:

**cURL**

**Створення Особи:**

```bash
curl -X POST http://localhost:3000/person -H "Content-Type: application/json" -d '{
    "name": "Тарас",
    "surname": "Шевченко",
    "patronym": "Григорович",
    "dateOfBirth": "1991-03-09",
    "rnokpp": "1234567890",
    "unzr": "12345678-12345",
    "passportNumber": "123456789",
    "gender": "male"
  }'
```

**Отримання Осіб за параметрами запиту:**

```bash
curl http://localhost:3000/person?name=Adam&dateOfBirth=1991-03-09
```

Приклад тіла відповіді:

  ```json
    {
        "totalCount": 1,
        "persons": [
            {
                "id": 1,
                "name": "Тарас",
                "surname": "Шевченко",
                "patronym": "Григорович",
                "dateOfBirth": "1991-03-09",
                "rnokpp": "1234567890",
                "unzr": "12345678-12345",
                "passportNumber": "123456789",
                "gender": "male",
                "createdAt": "2024-05-22T15:47:35.000Z",
                "updatedAt": "2024-06-07T15:08:28.000Z"
            }
        ]
    }
  ```


**Оновлення Осіб за атрибутом:**

```bash
curl -X PUT http://localhost:3000/person -H "Content-Type: application/json" -d '{
    "attribute": "unzr",
    "value": "12345678-12345",
    "name": "Степан"
}'
```

**Видалення Осіб за атрибутом:**

```bash
curl -X DELETE http://localhost:3000/person -H "Content-Type: application/json" -d '{
    "attribute": "unzr",
    "value": "12345678-12345"
}'
```

**Отримання статусу сервісу (Heartbeat):**

```bash
curl http://localhost:3000/status
```

Приклад тіла відповіді:

  ```json
    {
    "status": "OK",
    "details": 
        {
        "database": "connected"
        }
    }
  ```
В разі виникнення  проблеми з підключенням до бази даних або іншої внутрішньої помилки:
  
```json
    {
    "status": "fail",
    "details": 
        {
        "database": "disconnected",
        "error": "Access denied for user 'service'@'10.0.20.100' (using password: YES)"
        }
}
  ```


### Залежності

- express: Швидкий, бездоганний, мінімалістичний веб-фреймворк для Node.js.
- swagger: Iнструмент для документування API
- sequelize: Об'єктно-реляційний мапер Node.js на базі обіцянок.
- winston: Логер для майже всього.
- express-validator: Middleware Express для валідації.
- morgan: Middleware реєстрації запитів HTTP для Node.js.
- dotenv: Завантажує змінні середовища з файлу .env в process.env.
- helmet: Допомагає захистити додатки Express, встановлюючи різноманітні HTTP-заголовки.
- body-parser: Middleware розбору тіла запиту Node.js.


## Автор

Вебсервіс на базі REST з Node.js та Express.js був розроблений [Roman Lakhnov](mailto:lakhnov.roman@gmail.com).

## Ліцензія

Цей проект ліцензований під MIT License - детальніше дивіться у файлі [LICENSE.md](./LICENSE.md).
