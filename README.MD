# Проєкт Взаємодії з Трембітою. Javascript REST Service

## Опис

Цей проєкт входить в набір прикладів взаємодії з API шлюзу безпечного обміну системи Трембіта (ШБО), що демонструють технічні особливості розробки вебсервісів та вебклієнтів, сумісних з системою Трембіта. Даний проєкт представляє опис створення сумісного REST-сервісу на мові програмування Javascript з використанням Node.js та фреймворку EXPRESS. EXPRESS - швидкий, мінімалістичний веб-фреймворк для Node.js. для побудови API. Проєкт підтримує систему Трембіта (логування заголовків).
Приклад описує отримання з умовної бази даних (реєстру) відомостей про інформаційні об'єкти (у прикладі об'єктом є користувач) та управління їх статусом, у тому числі обробку запитів на пошук, отримання, створення, редагування та видалення об'єктів через REST API, що доступне через систему Трембіта.

## Зміст

- [Опис](#опис)
- [Вимоги](#вимоги)
- [Встановлення](#встановлення)
  - [Ручне розгортання серверу](#ручне-розгортання-серверу)
  - [Встановлення за допомогою скрипта deploy.sh](#встановлення-за-допомогою-скрипта)
- [Структура проєкту](#структура-проєкту)
- [Використання](#використання)
  - [Ручний запуск сервера](#ручний-запуск-сервера)
  - [Swagger Документація](#swagger-документація)
- [Документація](#документація)
  - [Опис роутів](#опис-роутів)
  - [Валідація запитів](#валідація-запитів)
  - [Санітаризація запитів](#санітаризація-запитів)
  - [Логування](#логування)
  - [Обробка помилок](#обробка-помилок)
  - [Контролери та Сервіси](#контролери-та-сервіси)
  - [Місця бізнес-логіки](#місця-бізнес-логіки)
- [Ендпоінти детально](#ендпоінти-детально)
  - [Створення Особи](#створення-особи)
  - [Отримання Осіб за параметрами запиту](#отримання-осіб-за-параметрами-запиту)
  - [Оновлення Осіб за атрибутом](#оновлення-осіб-за-атрибутом)
  - [Видалення Особи за унікальним атрибутом](#видалення-особи-за-унікальним-атрибутом)
  - [Отримання статусу сервісу (Heartbeat)](#отримання-статусу-сервісу-heartbeat)
- [Приклади використання](#приклади-використання)
  - [cURL](#curl)
- [Залежності](#залежності)
- [Ліцензія](#ліцензія)

## Вимоги

- Node js 20.14.0+
- Git (для клонування репозиторію)
- MariaDB 10.5+
- Ubuntu Server 24.04 -- рекомендована ОС для розгортання серверу.

## Встановлення

### Ручне розгортання серверу

1. Впевніться, що встановлені всі необхідні залежності, включаючи Node.js та npm, MariaDB.

2. Клонуйте репозиторій:

    ```bash
    git clone https://github.com/kshypachov/rest-sync-service-node-express-js.git
    ```

3. Перейдіть у директорію проекту:

    ```bash
    cd rest-sync-service-node-express-js
    ```

4. Встановіть залежності:

    ```bash
    npm install
    ```

5. Створіть файл .env у кореневій директорії проекту і заповніть необхідні змінні середовища, в тому числі данні для підключення до бази даних. Зразок данних наведено в файлі .env.example.

6. Виконайте міграцію для створення таблиці Persons в базі даних:

    ```bash
    npx sequelize db:migrate
    ```

### Встановлення за допомогою скрипта

Встановлення залежностей, налаштування бази даних та розгортання серверу виконується за допомогою скрипта deploy.sh (виключно для ОС Linux)

Скрипт `deploy.sh` призначений для автоматизації процесу встановлення. Скрипт виконує наступні кроки:

1. Встановлює системні залежності.
2. Клонує репозиторій.
3. Встановлює залежності Node js.
4. Налаштовує конфігурацію бази даних.
5. Створює структуру бази даних.
6. Створює `systemd` сервіс для запуску застосунку.

#### Використання скрипта deploy.sh

1. Відредагуйте скрипт `deploy.sh`, замінивши значення змінних `DB_USER`, `DB_PASSWORD`, `DB_NAME` на ваші бажані дані.
2. Зробіть файл виконуваним:

   ```bash
   chmod +x deploy.sh
   ```

3. Запустіть скрипт:

   ```bash
   ./deploy.sh
   ```

## Структура проєкту

Структура проєкту виглядає наступним чином:

```bash
rest-sync-service-node-express-js/
|-- config                                  # Директорія з конфігурацією застосунку
|   |-- config.js                           # Конфігурація бд
|-- controllers                             # Директорія з контролерами
|   |-- personController.js                 # Контролер для роботи з особами
|   |-- statusController.js                 # Контролер для роботи зі статусом
|-- logs                                    # Директорія для зберігання логів
|   |-- combined.log                        # Логи для об'єднаних повідомлень
|   |-- error.log                           # Логи для повідомлень про помилки
|-- middleware                              # Директорія з проміжними обробниками 
|   |-- contentTypeValidation.js            # Валідація типів вмісту
|   |-- logger.js                           # Логування
|   |-- personValidation.js                 # Валідація параметрів
|   |-- requestLogger.js                    # Логування запитів
|   |-- responseLogger.js                   # Логування відповідей
|-- migrations                              # Директорія з міграціями бази даних
|   |-- 20240518104703-add_Persons_table.js # Конфігурація міграцій БД для додавання таблиці осіб
|-- models                                  # Директорія з моделями даних
|   |-- index.js                            # Підключення моделей 
|   |-- Person.js                           # Модель особи
|-- node_modules *                          # Директорія з залежностями Node.js
|-- routes                                  # Директорія з маршрутами 
|   |-- person.js                           # Маршрути для роботи з особами
|   |-- status.js                           # Маршрути для роботи зі статусами
|-- services                                # Директорія з сервісами
|   |-- personService.js                    # Сервіс для обробки логіки роботи з особами
|   |-- statusService.js                    # Сервіс для обробки логіки роботи зі статусом
|-- .env                                    # Конфігурація середовища
|-- .gitignore                              # Ігнорування файлів Git
|-- .sequelizerc                            # Конфігурація Sequelize
|-- app.js                                  # Основний файл застосунку
|-- deploy.sh                               # Скрипт для автоматизації встановлення
|-- index.js                                # Точка входу застосунку
|-- package.json                            # Залежності проєкту
|-- package-lock.json                       # Файл блокування залежностей
|-- README.MD                               # Документація проєкту
|-- swagger-output.json                     # Вихідний файл Swagger документації
|-- swagger.js                              # Конфігурація Swagger документації
```

## Використання

### Ручний запуск сервера

Щоб запустити сервер у режимі продакшену, виконайте команду:

```bash
npm start
```

Для запуску сервера у режимі розробки з nodemon (автоматично перезапускається при зміні файлів) виконайте:

```bash
npm run dev
```

### Swagger Документація

Документація вашого API, автоматично створена з використанням Swagger, надає інтерактивний спосіб ознайомитися з усіма доступними ендпоінтами, параметрами запитів та структурою даних.

Для перегляду Swagger-документації, після запуску сервісу перейдіть за адресою:

http://адреса_вашого_api/api-docs

#### Використання Swagger

Swagger надає зручний інтерфейс для тестування та використання вашого API. Ви можете:

- Оглядати список доступних ендпоінтів.
- Детально ознайомитися з параметрами кожного ендпоінту.
- Виконувати запити безпосередньо з інтерфейсу Swagger.

В разі внесення змін до ендпоінтів сервера, для актуалізаціі Swagger-документації виконайте:

```bash
npm run swagger
```

### Документація

#### Опис роутів

- `/person`
  - `POST`: Створення нового запису про особу.
  - `GET`: Отримання списку осіб за параметрами запиту.
  - `PUT`: Оновлення осіб за атрибутом.
  - `DELETE`: Видалення осіб за атрибутом.
- `/status`
  - `GET`: Отримання статусу сервісу (Heartbeat).

#### Валідація запитів

Для створення запису про особу використовується middleware для валідації даних. Перевіряються наступні поля: ім'я, прізвище, по батькові, дата народження, коди RNOKPP та UNZR, номер паспорту та стать за наступними критеріями:

- name: Перевіряє, щоб довжина поля була від 1 до 50 символів.
- surname: Перевіряє, щоб довжина поля була від 1 до 50 символів.
- patronym: Якщо присутнє, перевіряє, щоб довжина поля не була більше 50 символів.
- dateOfBirth: Перевіряє, щоб поле містило дату у форматі 'YYYY-MM-DD'.
- rnokpp: Перевіряє, щоб довжина поля дорівнювала 10 символів.
- unzr: Перевіряє, щоб довжина поля дорівнювала 14 символів.
- passportNumber: Перевіряє, щоб довжина поля дорівнювала 9 символів.
- gender: Перевіряє, щоб значення поля було або "male", або "female".

Якщо будь-яка перевірка не пройде, видається відповідне повідомлення про помилку.

#### Санітаризація запитів

Middleware для валідації даних також виконує санітаризацію запитів.

Санітайзер видаляє пробіли з обох кінців рядка, а також замінює <, >, &, ', " та / відповідними об'єктами HTML. Це сприяє для запобігання атакам XSS, гарантуючи, що введені користувачем дані розглядаються як звичайний текст, а не як виконуваний HTML або JavaScript.

ORM Sequelize використовує параметризовані запити для взаємодії з базою даних, що відокремлює логіку SQL від даних.

Це забезпечує надійний захист від атак SQL-ін’єкцій.

#### Логування

- Здійснюється логування HTTP запитів та відповідей, а також помилок за допомогою Winston logger. Логи зберігаються у відповідних файлах згідно налаштувань середовища.

#### Обробка помилок

- Помилки під час виконання запитів обробляються та логуються. Клієнт отримує відповідний статус та повідомлення про помилку.

#### Контролери та Сервіси

- Всі операції з базою даних винесені у сервіси, а логіка керування ними зосереджена у контролерах.

#### Місця бізнес-логіки

- Бізнес-логіка зосереджена у сервісах та контролерах, які здійснюють операції з даними.

### Ендпоінти детально

#### Створення Особи

Для створення нового запису про особу виконайте POST запит на адресу /person, передаючи необхідні дані в тілі запиту.

- **URL:** `/person`
- **Метод:** `POST`
- **Тіло запиту:**

  ```json
  {
    "name": "Тарас",
    "surname": "Шевченко",
    "patronym": "Григорович",
    "dateOfBirth": "1991-03-09",
    "rnokpp": "1234567890",
    "unzr": "12345678-12345",
    "passportNumber": "123456789",
    "gender": "male"
  }
  ```

#### Отримання Осіб за параметрами запиту

Для отримання списку осіб виконайте GET запит на адресу /person, можливо також вказати різні параметри фільтрації.

- **URL:** `/person`
- **Метод:** `GET`
- **Параметри запиту:**
 (Будь-яке поєднання атрибутів особи, на приклад
?name=Adam&dateOfBirth=1991-03-09)

#### Оновлення Осіб за атрибутом

Для оновлення інформації про осіб виконайте PUT запит на адресу /person, передаючи назву атрибуту та значення, а також нові дані в тілі запиту.

- **URL:** `/person`
- **Метод:** `PUT`
- **Тіло запиту:**

  ```json
  { 
    "attribute": "unzr",
    "value": "12345678-12345",
    "name": "Степан",
  }
  ```

#### Видалення Особи за унікальним атрибутом

Для видалення записів виконайте DELETE запит на адресу /person, передаючи назву атрибуту та значення, для осіб котрих потрібно видалити.

- **URL:** `/person`
- **Метод:** `DELETE`
- **Тіло запиту:**

  ```json
  { 
    "attribute": "unzr",
    "value": "12345678-12345"
  }
  ```

#### Отримання статусу сервісу (Heartbeat)

Сервер підтримує Heartbeat link для перевірки статусу сервісу. Це можна зробити шляхом виконання GET-запиту на маршрут `/status`.

- **URL:** `/status`
- **Метод:** `GET`

### Приклади використання

Припускаючи, що сервер працює локально на порту 3000:

#### cURL

**Створення Особи:**

```bash
curl -X POST http://localhost:3000/person -H "Content-Type: application/json" -d '{
    "name": "Тарас",
    "surname": "Шевченко",
    "patronym": "Григорович",
    "dateOfBirth": "1991-03-09",
    "rnokpp": "1234567890",
    "unzr": "12345678-12345",
    "passportNumber": "123456789",
    "gender": "male"
  }'
```

**Отримання Осіб за параметрами запиту:**

```bash
curl http://localhost:3000/person?name=Adam&dateOfBirth=1991-03-09
```

**Приклад тіла відповіді:**

  ```json
    {
        "totalCount": 1,
        "persons": [
            {
                "id": 1,
                "name": "Тарас",
                "surname": "Шевченко",
                "patronym": "Григорович",
                "dateOfBirth": "1991-03-09",
                "rnokpp": "1234567890",
                "unzr": "12345678-12345",
                "passportNumber": "123456789",
                "gender": "male",
                "createdAt": "2024-05-22T15:47:35.000Z",
                "updatedAt": "2024-06-07T15:08:28.000Z"
            }
        ]
    }
  ```

**Оновлення Осіб за атрибутом:**

```bash
curl -X PUT http://localhost:3000/person -H "Content-Type: application/json" -d '{
    "attribute": "unzr",
    "value": "12345678-12345",
    "name": "Степан"
}'
```

**Видалення Осіб за атрибутом:**

```bash
curl -X DELETE http://localhost:3000/person -H "Content-Type: application/json" -d '{
    "attribute": "unzr",
    "value": "12345678-12345"
}'
```

**Отримання статусу сервісу (Heartbeat):**

```bash
curl http://localhost:3000/status
```

Приклад тіла відповіді:

  ```json
    {
    "status": "OK",
    "details": 
        {
        "database": "connected"
        }
    }
  ```

В разі виникнення  проблеми з підключенням до бази даних або іншої внутрішньої помилки:
  
```json
    {
    "status": "fail",
    "details": 
        {
        "database": "disconnected",
        "error": "Access denied for user 'service'@'10.0.20.100' (using password: YES)"
        }
}
  ```

### Залежності

- express: Швидкий, бездоганний, мінімалістичний веб-фреймворк для Node.js.
- swagger: Iнструмент для документування API
- sequelize: Об'єктно-реляційний мапер Node.js на базі обіцянок.
- winston: Логер для майже всього.
- express-validator: Middleware Express для валідації.
- morgan: Middleware реєстрації запитів HTTP для Node.js.
- dotenv: Завантажує змінні середовища з файлу .env в process.env.
- helmet: Допомагає захистити додатки Express, встановлюючи різноманітні HTTP-заголовки.
- body-parser: Middleware розбору тіла запиту Node.js.

## Ліцензія

Вебсервіс на базі REST з Node.js та Express.js був розроблений [Roman Lakhnov](mailto:lakhnov.roman@gmail.com).

Цей проєкт ліцензований під ліцензією GPL v3 - детальніше дивіться у файлі [LICENSE.md](./LICENSE.md).
